---
import { siteConfig } from '@/data/siteConfig';
import { makeHref } from '@/lib/nav';
import { makeTelHref } from '@/lib/links';

type Props = {
  /** Hide the sticky actions on specific pages (e.g., when a form is already on-screen). */
  hidden?: boolean;
};

const { hidden = false } = Astro.props;

const href = makeHref(import.meta.env.BASE_URL);
const telHref = makeTelHref(siteConfig.contact.phoneE164);
---

{
  !hidden ? (
    <div
      class="pointer-events-none fixed inset-x-0 bottom-0 z-40 pb-[max(0.75rem,env(safe-area-inset-bottom))] transition-all duration-200 ease-out"
      aria-hidden="false"
      data-sticky-actions
      data-hidden="false"
    >
      <div class="container-page">
        <div class="border-app pointer-events-auto mx-auto w-full max-w-lg rounded-[var(--radius-card)] border bg-white p-2 shadow-soft dark:bg-slate-950/30">
          <div class="grid grid-cols-2 gap-2">
            <a
              class="btn-secondary h-12 w-full justify-center"
              href={telHref}
              data-analytics="sticky_phone"
            >
              Call/Text
            </a>
            <a
              class="btn-primary h-12 w-full justify-center"
              href={href('contact/')}
              data-analytics="sticky_quote"
            >
              Request a quote
            </a>
          </div>
        </div>
      </div>
    </div>
  ) : null
}

<script>
  (() => {
    const bar = document.querySelector<HTMLElement>('[data-sticky-actions]');
    if (!bar) return;

    const root = document.documentElement;

    const setPad = (px: number) => {
      const value = `${Math.max(0, Math.round(px))}px`;
      root.style.setProperty('--sticky-actions-pad', value);
    };

    const measure = () => {
      // If hidden via attribute, do not reserve space.
      const hidden = bar.getAttribute('data-hidden') === 'true';
      if (hidden) {
        setPad(0);
        return;
      }
      const rect = bar.getBoundingClientRect();
      setPad(rect.height);
    };

    // Smooth hide/show without removing from layout.
    const setHidden = (hidden: boolean) => {
      bar.setAttribute('data-hidden', hidden ? 'true' : 'false');
      if (!hidden) {
        bar.style.opacity = '1';
        bar.style.transform = 'translateY(0)';
        // Reserve space so the bar doesn't cover content.
        measure();
        return;
      }
      bar.style.opacity = '0';
      bar.style.transform = 'translateY(14px)';
      setPad(0);
    };

    // Initial measurement.
    measure();

    // Keep the reserved space correct on rotation / resize.
    window.addEventListener('resize', () => {
      // Defer to next frame so layout has settled.
      requestAnimationFrame(measure);
    });

    // Hide when the footer is visible (prevents overlapping the footer content).
    const footer = document.querySelector('footer');
    if (!footer || typeof IntersectionObserver !== 'function') return;

    const io = new IntersectionObserver(
      (entries) => {
        const anyVisible = entries.some((e) => e.isIntersecting);
        setHidden(anyVisible);
      },
      {
        root: null,
        // Start hiding a little before the footer fully enters.
        rootMargin: '0px 0px -20% 0px',
        threshold: 0.01,
      }
    );

    io.observe(footer);
  })();
</script>
