---
import { siteConfig } from '@/data/siteConfig';

type Props = {
  formEndpoint: string | undefined;
  isDev?: boolean;
  mailtoTo: string;
  sourcePath: string;
  successRedirect: string | undefined;
  industryOptions: string[];
  serviceOptions: string[];

  /** For aria-describedby; keep stable across instances. */
  helpId?: string;
  servicesHelpId?: string;
};

const {
  formEndpoint,
  isDev = false,
  mailtoTo,
  sourcePath,
  successRedirect,
  industryOptions,
  serviceOptions,
  helpId = 'contact-help',
  servicesHelpId = 'services-help',
} = Astro.props;

const servicesErrorId = `${servicesHelpId}-error`;
---

<div>
  {
    !formEndpoint && (
      <div class="mb-4 rounded-[var(--radius-card)] border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900">
        {isDev ? (
          <>
            <p class="font-semibold">Form endpoint not configured</p>
            <p class="mt-1">
              Set <code class="rounded bg-white px-1.5 py-0.5">PUBLIC_FORM_ENDPOINT</code> in
              <code class="rounded bg-white px-1.5 py-0.5">.env</code> (see
              <code class="rounded bg-white px-1.5 py-0.5">.env.example</code>) to enable
              submissions. For now, this form will open your email app with the details filled in.
            </p>
          </>
        ) : (
          <>
            <p class="font-semibold">We’ll reply fast</p>
            <p class="mt-1">
              When you submit, this form will open your email app with the message filled in. If you
              prefer, call/text us instead.
            </p>
          </>
        )}
      </div>
    )
  }

  <form
    action={formEndpoint ?? '#'}
    method="POST"
    class="grid gap-4"
    data-contact-form
    data-form-endpoint={formEndpoint ?? ''}
    data-mailto-to={mailtoTo}
    data-success-redirect={successRedirect ?? ''}
    aria-describedby={helpId}
  >
    <input type="hidden" name="source" value={sourcePath} />

    <p id={helpId} class="text-sm text-muted">
      Fields marked with <span class="font-semibold">*</span> are required.
    </p>

    <p
      class="hidden rounded-xl border px-3 py-2 text-sm"
      data-contact-status
      data-contact-status-kind="info"
      role="status"
      aria-live="polite"
      aria-atomic="true"
    >
    </p>

    <div class="grid gap-4 sm:grid-cols-2">
      <label class="grid gap-1 text-sm">
        <span class="text-strong font-semibold">Company / Organization *</span>
        <input
          class="input"
          type="text"
          name="companyName"
          autocomplete="organization"
          autocapitalize="words"
          enterkeyhint="next"
          required
        />
      </label>

      <label class="grid gap-1 text-sm">
        <span class="text-strong font-semibold">Contact name *</span>
        <input
          class="input"
          type="text"
          name="name"
          autocomplete="name"
          autocapitalize="words"
          enterkeyhint="next"
          required
        />
      </label>

      <label class="grid gap-1 text-sm">
        <span class="text-strong font-semibold">Email *</span>
        <input
          class="input"
          type="email"
          name="email"
          autocomplete="email"
          inputmode="email"
          autocapitalize="none"
          spellcheck="false"
          enterkeyhint="next"
          required
        />
      </label>

      <label class="grid gap-1 text-sm">
        <span class="text-strong font-semibold">Phone</span>
        <input
          class="input"
          type="tel"
          name="phone"
          autocomplete="tel"
          inputmode="tel"
          enterkeyhint="next"
        />
      </label>
    </div>

    <div class="grid gap-4 sm:grid-cols-2">
      <label class="grid gap-1 text-sm">
        <span class="text-strong font-semibold">Preferred contact</span>
        <select class="select" name="contactMethod">
          <option value="Email">Email</option>
          <option value="Phone">Phone</option>
          <option value="Text">Text</option>
        </select>
      </label>

      <label class="grid gap-1 text-sm">
        <span class="text-strong font-semibold">Location (City + ZIP) *</span>
        <input
          class="input"
          type="text"
          name="location"
          autocomplete="postal-code"
          enterkeyhint="next"
          required
          placeholder="Example: San Francisco, 94103"
        />
      </label>
    </div>

    <div class="grid gap-4 sm:grid-cols-2">
      <label class="grid gap-1 text-sm">
        <span class="text-strong font-semibold">Industry *</span>
        <select class="select" name="industry" required>
          <option value="">Select an industry</option>
          {industryOptions.map((opt) => <option value={opt}>{opt}</option>)}
        </select>
      </label>

      <label class="grid gap-1 text-sm">
        <span class="text-strong font-semibold">Cleaning frequency *</span>
        <select class="select" name="frequency" required>
          <option value="">Select a frequency</option>
          <option value="One-time">One-time</option>
          <option value="Weekly">Weekly</option>
          <option value="2–3x / week">2–3x / week</option>
          <option value="Daily">Daily</option>
          <option value="Day porter">Day porter</option>
          <option value="Not sure">Not sure</option>
          <option value="Custom">Custom</option>
        </select>
      </label>

      <label class="grid gap-1 text-sm sm:col-span-2">
        <span class="text-strong font-semibold">Timing</span>
        <select class="select" name="startTiming">
          <option value="ASAP">ASAP</option>
          <option value="Within 2 weeks">Within 2 weeks</option>
          <option value="Within a month">Within a month</option>
          <option value="Just researching">Just researching</option>
        </select>
      </label>
    </div>

    <fieldset
      class="grid gap-2 text-sm"
      aria-describedby={`${servicesHelpId} ${servicesErrorId}`}
      aria-required="true"
    >
      <legend class="text-strong font-semibold">Services needed *</legend>
      <p id={servicesHelpId} class="text-subtle text-xs">
        Pick all that apply. We’ll confirm scope during quoting.
      </p>
      <div class="rounded-xl border p-3" data-services-box>
        <div class="grid gap-2 sm:grid-cols-2">
          {
            serviceOptions.map((opt) => (
              <label class="flex cursor-pointer items-start gap-2">
                <input class="checkbox mt-1" type="checkbox" name="servicesNeeded" value={opt} />
                <span class="text-muted">{opt}</span>
              </label>
            ))
          }
        </div>
      </div>

      <p id={servicesErrorId} class="hidden text-xs text-rose-700" data-services-error>
        Please pick at least one service.
      </p>
    </fieldset>

    <label class="grid gap-1 text-sm">
      <span class="text-strong font-semibold">Notes / scope details *</span>
      <textarea
        class="textarea min-h-28"
        name="message"
        required
        enterkeyhint="send"
        placeholder="Example: ~2,500 sq ft office; weekly after 6pm; focus on restrooms + kitchen; monthly deep clean."
      ></textarea>
    </label>

    <div class="hidden" aria-hidden="true">
      <label>
        Website
        <input type="text" name="website" tabindex="-1" autocomplete="off" />
      </label>
    </div>

    <button class="btn-primary" type="submit" data-contact-submit> Submit Request </button>

    <label class="flex cursor-pointer items-start gap-2 text-sm">
      <input class="checkbox mt-0.5" type="checkbox" name="consent" value="Yes" required />
      <span class="text-subtle">I agree to be contacted about this quote request. No spam.</span>
    </label>

    <p class="text-caption">
      By submitting, you agree to be contacted by {siteConfig.brand.name} about your request.
    </p>
  </form>
</div>
