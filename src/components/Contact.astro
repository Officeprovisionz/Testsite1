---
import { siteConfig } from '@/data/siteConfig';
import { makeMailtoHref, makeTelHref } from '@/lib/links';

type Props = {
  id?: string;
  heading?: string;
  description?: string;
  /**
   * `section` renders the full section with background + container.
   * `embed` renders a compact block (useful inside a page grid).
   */
  variant?: 'section' | 'embed';
  /** Hide the left-side info panel (phone/email/hours) and render only the form card. */
  showSidebar?: boolean;
};

const {
  id,
  heading = 'Request a quote',
  description = 'Share a few details about your space and services needed. We’ll confirm scope (often via a walkthrough), then send a clear written quote.',
  variant = 'section',
  showSidebar = true,
} = Astro.props;

const formEndpoint = import.meta.env.PUBLIC_FORM_ENDPOINT;
const isDev = import.meta.env.DEV;
const telHref = makeTelHref(siteConfig.contact.phoneE164);
const mailtoTo = siteConfig.contact.email;
const mailtoHref = makeMailtoHref(siteConfig.contact.email);
const sourcePath = Astro.url.pathname;

const industryOptions = [...siteConfig.industries.map((i) => i.title), 'Other / Not listed'];

const serviceOptions = [
  'Recurring Janitorial (Nightly/Weekly)',
  'Office Cleaning',
  'Deep / Detail Cleaning',
  'Day Porter / Daytime Upkeep',
  'Supplies & Restocking',
  'Facilities Support',
  'Move-In / Move-Out (Office Turnovers)',
  'Post-Construction Cleanup',
  'Other / Not sure',
];
---

<div class="contents">
  {
    variant === 'embed' ? (
      <div id={id} class="glass-card relative overflow-hidden p-6 sm:p-7">
        <div
          aria-hidden="true"
          class="from-brand-200/16 to-brand-300/12 pointer-events-none absolute inset-0 bg-gradient-to-br via-transparent"
        />
        <div class="relative">
          <h2 class="heading-3">{heading}</h2>
          {description ? <p class="mt-2 text-sm text-muted">{description}</p> : null}

          {!formEndpoint && (
            <div class="mb-4 rounded-xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900">
              {isDev ? (
                <>
                  <p class="font-semibold">Form endpoint not configured</p>
                  <p class="mt-1">
                    Set <code class="rounded bg-white px-1.5 py-0.5">PUBLIC_FORM_ENDPOINT</code> in
                    <code class="rounded bg-white px-1.5 py-0.5">.env</code> (see
                    <code class="rounded bg-white px-1.5 py-0.5">.env.example</code>) to enable
                    submissions. For now, this form will open your email app with the details filled
                    in.
                  </p>
                </>
              ) : (
                <>
                  <p class="font-semibold">We’ll reply fast</p>
                  <p class="mt-1">
                    When you submit, this form will open your email app with the message filled in.
                    If you prefer, call/text us instead.
                  </p>
                </>
              )}
            </div>
          )}
          <form
            action={formEndpoint ?? '#'}
            method="POST"
            class="grid gap-4"
            data-contact-form
            data-form-endpoint={formEndpoint ?? ''}
            data-mailto-to={mailtoTo}
            aria-describedby="contact-help"
          >
            <input type="hidden" name="source" value={sourcePath} />

            <p id="contact-help" class="text-sm text-muted">
              Fields marked with <span class="font-semibold">*</span> are required.
            </p>

            <p
              class="hidden rounded-xl border px-3 py-2 text-sm"
              data-contact-status
              data-contact-status-kind="info"
              role="status"
              aria-live="polite"
            />

            <div class="grid gap-4 sm:grid-cols-2">
              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Company / Organization *</span>
                <input
                  class="input"
                  type="text"
                  name="companyName"
                  autocomplete="organization"
                  autocapitalize="words"
                  required
                />
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Contact name *</span>
                <input
                  class="input"
                  type="text"
                  name="name"
                  autocomplete="name"
                  autocapitalize="words"
                  required
                />
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Email *</span>
                <input
                  class="input"
                  type="email"
                  name="email"
                  autocomplete="email"
                  inputmode="email"
                  required
                />
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Phone</span>
                <input class="input" type="tel" name="phone" autocomplete="tel" inputmode="tel" />
              </label>
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Preferred contact</span>
                <select class="select" name="contactMethod">
                  <option value="Email">Email</option>
                  <option value="Phone">Phone</option>
                  <option value="Text">Text</option>
                </select>
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Location (City + ZIP) *</span>
                <input
                  class="input"
                  type="text"
                  name="location"
                  autocomplete="postal-code"
                  required
                  placeholder="Example: San Francisco, 94103"
                />
              </label>
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Industry *</span>
                <select class="select" name="industry" required>
                  <option value="">Select an industry</option>
                  {industryOptions.map((opt) => (
                    <option value={opt}>{opt}</option>
                  ))}
                </select>
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Cleaning frequency *</span>
                <select class="select" name="frequency" required>
                  <option value="">Select a frequency</option>
                  <option value="One-time">One-time</option>
                  <option value="Weekly">Weekly</option>
                  <option value="2–3x / week">2–3x / week</option>
                  <option value="Daily">Daily</option>
                  <option value="Day porter">Day porter</option>
                  <option value="Not sure">Not sure</option>
                  <option value="Custom">Custom</option>
                </select>
              </label>

              <label class="grid gap-1 text-sm sm:col-span-2">
                <span class="text-strong font-semibold">Timing</span>
                <select class="select" name="startTiming">
                  <option value="ASAP">ASAP</option>
                  <option value="Within 2 weeks">Within 2 weeks</option>
                  <option value="Within a month">Within a month</option>
                  <option value="Just researching">Just researching</option>
                </select>
              </label>
            </div>

            <fieldset class="grid gap-2 text-sm" aria-describedby="services-help">
              <legend class="text-strong font-semibold">Services needed *</legend>
              <p id="services-help" class="text-subtle text-xs">
                Pick all that apply. We’ll confirm scope during quoting.
              </p>
              <div class="grid gap-2 sm:grid-cols-2">
                {serviceOptions.map((opt) => (
                  <label class="flex items-start gap-2">
                    <input
                      class="checkbox mt-1"
                      type="checkbox"
                      name="servicesNeeded"
                      value={opt}
                    />
                    <span class="text-muted">{opt}</span>
                  </label>
                ))}
              </div>
            </fieldset>

            <label class="grid gap-1 text-sm">
              <span class="text-strong font-semibold">Notes / scope details *</span>
              <textarea
                class="textarea min-h-28"
                name="message"
                required
                placeholder="Example: ~2,500 sq ft office; weekly after 6pm; focus on restrooms + kitchen; monthly deep clean."
              />
            </label>

            {/* Honeypot (bots will often fill this). Keep it visually hidden. */}
            <div class="hidden" aria-hidden="true">
              <label>
                Website
                <input type="text" name="website" tabindex="-1" autocomplete="off" />
              </label>
            </div>

            <button class="btn-primary" type="submit" data-contact-submit>
              Submit Request
            </button>

            <label class="flex items-start gap-2 text-xs">
              <input class="checkbox mt-0.5" type="checkbox" name="consent" value="Yes" required />
              <span class="text-subtle">
                I agree to be contacted about this quote request. No spam.
              </span>
            </label>
          </form>
        </div>
      </div>
    ) : null
  }

  {
    variant !== 'embed' ? (
      <section id={id} class="section section-muted section-creative scroll-mt-20">
        <div class="container-page relative">
          <div aria-hidden="true" class="pointer-events-none absolute inset-x-0 -top-14 -z-10">
            <div class="mx-auto h-72 w-[min(74rem,96vw)] rounded-full bg-brand-500/10 blur-3xl" />
          </div>

          <div class:list={['grid gap-10', showSidebar ? 'lg:grid-cols-2' : 'lg:grid-cols-1']}>
            {showSidebar ? (
              <div>
                <h2 class="heading-2">{heading}</h2>
                <p class="lede">{description}</p>

                <div class="mt-6 space-y-3 text-sm text-muted">
                  <p>
                    <span class="text-strong font-semibold">Call/Text:</span>
                    <a class="underline decoration-brand-300/50 underline-offset-4" href={telHref}>
                      {siteConfig.contact.phoneDisplay}
                    </a>
                  </p>
                  <p>
                    <span class="text-strong font-semibold">Email:</span>
                    <a
                      class="underline decoration-brand-300/50 underline-offset-4"
                      href={mailtoHref}
                    >
                      {siteConfig.contact.email}
                    </a>
                  </p>
                  <div>
                    <p class="text-strong font-semibold">Hours</p>
                    <ul class="mt-1 grid gap-1">
                      {siteConfig.hours.lines.map((h) => (
                        <li>{h}</li>
                      ))}
                    </ul>
                  </div>
                </div>

                <div class="glass-panel relative mt-8 overflow-hidden p-6">
                  <div
                    aria-hidden="true"
                    class="from-brand-200/16 to-brand-300/12 pointer-events-none absolute inset-0 bg-gradient-to-br via-transparent"
                  />
                  <div class="relative">
                    <p class="text-strong text-sm font-semibold">What happens next</p>
                    <ol class="mt-2 grid gap-2 text-sm text-muted">
                      <li>
                        <span class="text-strong font-semibold">1.</span> We reply within 1 business
                        day.
                      </li>
                      <li>
                        <span class="text-strong font-semibold">2.</span> We confirm scope, access,
                        and any special requirements.
                      </li>
                      <li>
                        <span class="text-strong font-semibold">3.</span> You get a clear, written
                        quote.
                      </li>
                    </ol>

                    <p class="text-subtle mt-3 text-xs">
                      This form includes a hidden anti-spam field. We only use your details to
                      respond to your request.
                    </p>
                  </div>
                </div>
              </div>
            ) : null}

            <div class="glass-card relative overflow-hidden p-6 sm:p-7">
              <div
                aria-hidden="true"
                class="from-brand-200/16 to-brand-300/12 pointer-events-none absolute inset-0 bg-gradient-to-br via-transparent"
              />
              <div class="relative">
                {!formEndpoint && (
                  <div class="mb-4 rounded-xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900">
                    {isDev ? (
                      <>
                        <p class="font-semibold">Form endpoint not configured</p>
                        <p class="mt-1">
                          Set{' '}
                          <code class="rounded bg-white px-1.5 py-0.5">PUBLIC_FORM_ENDPOINT</code>{' '}
                          in
                          <code class="rounded bg-white px-1.5 py-0.5">.env</code> (see
                          <code class="rounded bg-white px-1.5 py-0.5">.env.example</code>) to
                          enable submissions. For now, this form will open your email app with the
                          details filled in.
                        </p>
                      </>
                    ) : (
                      <>
                        <p class="font-semibold">We’ll reply fast</p>
                        <p class="mt-1">
                          When you submit, this form will open your email app with the message
                          filled in. If you prefer, call/text us instead.
                        </p>
                      </>
                    )}
                  </div>
                )}

                <form
                  action={formEndpoint ?? '#'}
                  method="POST"
                  class="grid gap-4"
                  data-contact-form
                  data-form-endpoint={formEndpoint ?? ''}
                  data-mailto-to={mailtoTo}
                  aria-describedby="contact-help"
                >
                  <input type="hidden" name="source" value={sourcePath} />

                  <p id="contact-help" class="text-sm text-muted">
                    Fields marked with <span class="font-semibold">*</span> are required.
                  </p>

                  <p
                    class="hidden rounded-xl border px-3 py-2 text-sm"
                    data-contact-status
                    data-contact-status-kind="info"
                    role="status"
                    aria-live="polite"
                  />

                  <div class="grid gap-4 sm:grid-cols-2">
                    <label class="grid gap-1 text-sm">
                      <span class="text-strong font-semibold">Company / Organization *</span>
                      <input
                        class="input"
                        type="text"
                        name="companyName"
                        autocomplete="organization"
                        autocapitalize="words"
                        required
                      />
                    </label>

                    <label class="grid gap-1 text-sm">
                      <span class="text-strong font-semibold">Contact name *</span>
                      <input
                        class="input"
                        type="text"
                        name="name"
                        autocomplete="name"
                        autocapitalize="words"
                        required
                      />
                    </label>

                    <label class="grid gap-1 text-sm">
                      <span class="text-strong font-semibold">Email *</span>
                      <input
                        class="input"
                        type="email"
                        name="email"
                        autocomplete="email"
                        inputmode="email"
                        required
                      />
                    </label>

                    <label class="grid gap-1 text-sm">
                      <span class="text-strong font-semibold">Phone</span>
                      <input
                        class="input"
                        type="tel"
                        name="phone"
                        autocomplete="tel"
                        inputmode="tel"
                      />
                    </label>
                  </div>

                  <div class="grid gap-4 sm:grid-cols-2">
                    <label class="grid gap-1 text-sm">
                      <span class="text-strong font-semibold">Preferred contact</span>
                      <select class="select" name="contactMethod">
                        <option value="Email">Email</option>
                        <option value="Phone">Phone</option>
                        <option value="Text">Text</option>
                      </select>
                    </label>

                    <label class="grid gap-1 text-sm">
                      <span class="text-strong font-semibold">Location (City + ZIP) *</span>
                      <input
                        class="input"
                        type="text"
                        name="location"
                        autocomplete="postal-code"
                        required
                        placeholder="Example: San Francisco, 94103"
                      />
                    </label>
                  </div>

                  <div class="grid gap-4 sm:grid-cols-2">
                    <label class="grid gap-1 text-sm">
                      <span class="text-strong font-semibold">Industry *</span>
                      <select class="select" name="industry" required>
                        <option value="">Select an industry</option>
                        {industryOptions.map((opt) => (
                          <option value={opt}>{opt}</option>
                        ))}
                      </select>
                    </label>

                    <label class="grid gap-1 text-sm">
                      <span class="text-strong font-semibold">Cleaning frequency *</span>
                      <select class="select" name="frequency" required>
                        <option value="">Select a frequency</option>
                        <option value="One-time">One-time</option>
                        <option value="Weekly">Weekly</option>
                        <option value="2–3x / week">2–3x / week</option>
                        <option value="Daily">Daily</option>
                        <option value="Day porter">Day porter</option>
                        <option value="Not sure">Not sure</option>
                        <option value="Custom">Custom</option>
                      </select>
                    </label>

                    <label class="grid gap-1 text-sm sm:col-span-2">
                      <span class="text-strong font-semibold">Timing</span>
                      <select class="select" name="startTiming">
                        <option value="ASAP">ASAP</option>
                        <option value="Within 2 weeks">Within 2 weeks</option>
                        <option value="Within a month">Within a month</option>
                        <option value="Just researching">Just researching</option>
                      </select>
                    </label>
                  </div>

                  <fieldset class="grid gap-2 text-sm" aria-describedby="services-help">
                    <legend class="text-strong font-semibold">Services needed *</legend>
                    <p id="services-help" class="text-subtle text-xs">
                      Pick all that apply. We’ll confirm scope during quoting.
                    </p>
                    <div class="grid gap-2 sm:grid-cols-2">
                      {serviceOptions.map((opt) => (
                        <label class="flex items-start gap-2">
                          <input
                            class="checkbox mt-1"
                            type="checkbox"
                            name="servicesNeeded"
                            value={opt}
                          />
                          <span class="text-muted">{opt}</span>
                        </label>
                      ))}
                    </div>
                  </fieldset>

                  <label class="grid gap-1 text-sm">
                    <span class="text-strong font-semibold">Notes / scope details *</span>
                    <textarea
                      class="textarea min-h-28"
                      name="message"
                      required
                      placeholder="Example: ~2,500 sq ft office; weekly after 6pm; focus on restrooms + kitchen; monthly deep clean."
                    />
                  </label>

                  {/* Honeypot (bots will often fill this). Keep it visually hidden. */}
                  <div class="hidden" aria-hidden="true">
                    <label>
                      Website
                      <input type="text" name="website" tabindex="-1" autocomplete="off" />
                    </label>
                  </div>

                  <button class="btn-primary" type="submit" data-contact-submit>
                    Submit Request
                  </button>

                  <label class="flex items-start gap-2 text-xs">
                    <input
                      class="checkbox mt-0.5"
                      type="checkbox"
                      name="consent"
                      value="Yes"
                      required
                    />
                    <span class="text-subtle">
                      I agree to be contacted about this quote request. No spam.
                    </span>
                  </label>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>
    ) : null
  }
</div>

<script>
  (() => {
    const forms = Array.from(document.querySelectorAll<HTMLFormElement>('form[data-contact-form]'));
    if (!forms.length) return;

    const params = new URLSearchParams(window.location.search);

    const initForm = (form: HTMLFormElement) => {
      const endpoint = form.dataset.formEndpoint || '';

      const status = form.querySelector<HTMLElement>('[data-contact-status]');
      const submitBtn = form.querySelector<HTMLButtonElement>('[data-contact-submit]');

      type StatusKind = 'info' | 'success' | 'error';

      const escapeName = (value: string) => {
        try {
          if (window.CSS && typeof CSS.escape === 'function') return CSS.escape(String(value));
        } catch {
          // ignore
        }
        return String(value).replace(/["\\]/g, '\\$&');
      };

      const setStatus = (message: string, kind: StatusKind = 'info') => {
        if (!status) return;
        status.textContent = String(message);
        status.dataset.contactStatusKind = kind;
        status.classList.remove('hidden');

        // Visual styles via classes (kept simple and theme-safe).
        status.classList.remove(
          'text-muted',
          'border-app',
          'surface',
          'bg-brand-500/10',
          'border-brand-500/20',
          'text-strong',
          'bg-rose-50',
          'border-rose-200',
          'text-rose-900',
          'bg-rose-500/10',
          'border-rose-500/20'
        );

        if (kind === 'success') {
          status.classList.add('bg-brand-500/10', 'border-brand-500/20', 'text-strong');
        } else if (kind === 'error') {
          status.classList.add('bg-rose-500/10', 'border-rose-500/20', 'text-strong');
        } else {
          status.classList.add('surface', 'border-app', 'text-muted');
        }
      };

      const setBusy = (busy: boolean) => {
        form.setAttribute('aria-busy', busy ? 'true' : 'false');
        if (submitBtn) {
          submitBtn.disabled = busy;
          submitBtn.classList.toggle('opacity-70', busy);
          submitBtn.classList.toggle('cursor-not-allowed', busy);
          submitBtn.textContent = busy ? 'Sending…' : 'Submit Request';
        }
      };

      const focusFirstInvalid = () => {
        const el = form.querySelector<HTMLElement>(':invalid');
        el?.focus?.();
      };

      const setFieldInvalid = (name: string, invalid: boolean) => {
        const el = form.querySelector<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>(
          `[name="${escapeName(name)}"]`
        );
        if (!el) return;
        if (invalid) el.setAttribute('aria-invalid', 'true');
        else el.removeAttribute('aria-invalid');
      };

      const clearInvalidOnInput = () => {
        const watched = [
          'companyName',
          'name',
          'email',
          'location',
          'industry',
          'frequency',
          'message',
          'consent',
        ];
        watched.forEach((n) => {
          const el = form.querySelector(`[name="${escapeName(n)}"]`);
          if (!el) return;
          el.addEventListener('input', () => setFieldInvalid(n, false));
          el.addEventListener('change', () => setFieldInvalid(n, false));
        });
      };

      const prefillFromQuery = () => {
        const industry = params.get('industry');
        if (industry) {
          const sel = form.querySelector<HTMLSelectElement>('select[name="industry"]');
          if (sel && Array.from(sel.options).some((o) => o.value === industry)) {
            sel.value = industry;
            sel.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }

        // Support both service=One and services=a,b,c
        const servicesRaw = params.get('services') || params.get('service') || '';
        if (servicesRaw) {
          servicesRaw
            .split(',')
            .map((v) => v.trim())
            .filter(Boolean)
            .forEach((value) => {
              const box = form.querySelector<HTMLInputElement>(
                `input[type="checkbox"][name="servicesNeeded"][value="${escapeName(value)}"]`
              );
              if (box) box.checked = true;
            });
        }
      };

      prefillFromQuery();
      clearInvalidOnInput();

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const to = form.dataset.mailtoTo || '';
        if (!to) {
          setStatus('Email address not configured. Please call/text instead.');
          return;
        }

        const fd = new FormData(form);
        const source = String(fd.get('source') ?? '').trim();
        const companyName = String(fd.get('companyName') ?? '').trim();
        const name = String(fd.get('name') ?? '').trim();
        const email = String(fd.get('email') ?? '').trim();
        const phone = String(fd.get('phone') ?? '').trim();
        const contactMethod = String(fd.get('contactMethod') ?? '').trim();
        const location = String(fd.get('location') ?? '').trim();
        const industry = String(fd.get('industry') ?? '').trim();
        const frequency = String(fd.get('frequency') ?? '').trim();
        const startTiming = String(fd.get('startTiming') ?? '').trim();
        const servicesNeeded = fd
          .getAll('servicesNeeded')
          .map((v) => String(v).trim())
          .filter(Boolean);
        const consent = String(fd.get('consent') ?? '').trim();
        const message = String(fd.get('message') ?? '').trim();
        const honeypot = String(fd.get('website') ?? '').trim();

        // Simple bot check: if honeypot is filled, do nothing.
        if (honeypot) {
          setStatus('Thanks!', 'success');
          return;
        }

        if (
          !companyName ||
          !name ||
          !email ||
          !location ||
          !industry ||
          !frequency ||
          !message ||
          !consent ||
          !servicesNeeded.length
        ) {
          setFieldInvalid('companyName', !companyName);
          setFieldInvalid('name', !name);
          setFieldInvalid('email', !email);
          setFieldInvalid('location', !location);
          setFieldInvalid('industry', !industry);
          setFieldInvalid('frequency', !frequency);
          setFieldInvalid('message', !message);
          setFieldInvalid('consent', !consent);

          setStatus(
            'Please fill in the required fields (company, contact name, email, location, industry, frequency, services needed, consent, and notes).',
            'error'
          );
          focusFirstInvalid();
          return;
        }

        // If endpoint exists, try an async submission (better UX on mobile).
        if (endpoint && typeof fetch === 'function') {
          setBusy(true);
          setStatus('Sending…', 'info');

          fetch(endpoint, {
            method: 'POST',
            body: fd,
            headers: {
              Accept: 'application/json',
            },
          })
            .then(async (res) => {
              if (res.ok) return;

              // Try to parse a helpful error payload.
              let msg = 'Could not send your request. Please try again or call/text.';
              try {
                const data = await res.json();
                if (
                  data &&
                  typeof data === 'object' &&
                  'error' in data &&
                  typeof data.error === 'string'
                ) {
                  msg = data.error;
                }
              } catch {
                // ignore
              }
              throw new Error(msg);
            })
            .then(() => {
              setStatus('Quote request received — we’ll reply within 1 business day.', 'success');
              form.reset();
            })
            .catch((err) => {
              const msg = err instanceof Error ? err.message : 'Something went wrong.';
              setStatus(msg, 'error');
              // Fallback: attempt a normal submit (if endpoint supports it).
              try {
                form.submit();
              } catch {
                // ignore
              }
            })
            .finally(() => {
              setBusy(false);
            });

          return;
        }

        const subject = `Quote request — ${companyName || name}`;
        const body = [
          source ? `Page: ${source}` : undefined,
          companyName ? `Company: ${companyName}` : undefined,
          `Name: ${name}`,
          `Email: ${email}`,
          phone ? `Phone: ${phone}` : undefined,
          contactMethod ? `Preferred contact: ${contactMethod}` : undefined,
          location ? `Location: ${location}` : undefined,
          industry ? `Industry: ${industry}` : undefined,
          servicesNeeded.length ? `Services needed: ${servicesNeeded.join(', ')}` : undefined,
          frequency ? `Frequency: ${frequency}` : undefined,
          startTiming ? `Timing: ${startTiming}` : undefined,
          consent ? `Consent: ${consent}` : undefined,
          '',
          message,
        ]
          .filter(Boolean)
          .join('\n');

        setStatus('Opening your email app…', 'success');
        const href = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = href;
      });
    };

    forms.forEach(initForm);
  })();
</script>
