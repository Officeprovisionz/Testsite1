---
import { siteConfig } from '@/data/siteConfig';
import { makeHref, makeIsActive } from '@/lib/nav';
import { makeTelHref } from '@/lib/links';

type Props = {
  transparent?: boolean;
};

const { transparent = false } = Astro.props as Props;

const telHref = makeTelHref(siteConfig.contact.phoneE164);

const base = import.meta.env.BASE_URL;
const href = makeHref(base);
const isActive = makeIsActive(Astro.url.pathname, base);
const logoOrbSrc = `${base}brand/logo-orb.svg`;

const navItems = [
  { label: 'Services', href: href('services/') },
  { label: 'Industries', href: href('industries/') },
  { label: 'Resources', href: href('resources/') },
  { label: 'Company', href: href('about/') },
  { label: 'Contact', href: href('contact/') },
];
---

<header
  class:list={[
    'app-bar border-app sticky top-0 z-40 border-b transition-all duration-300',
    transparent ? 'header-transparent' : '',
  ]}
  data-site-header
>
  <div class="header-inner container-page flex items-center justify-between">
    <a
      href={href('')}
      class="flex items-center gap-3 text-xl font-bold tracking-tight"
      aria-label={`Go to ${siteConfig.brand.name} homepage`}
    >
      <img
        src={logoOrbSrc}
        alt=""
        width="28"
        height="28"
        loading="eager"
        decoding="async"
        class="brand-mark h-7 w-7 drop-shadow-sm"
      />
      <span
        class:list={['hidden sm:inline', transparent ? 'text-white drop-shadow-sm' : 'text-strong']}
      >
        {siteConfig.brand.name}
      </span>
    </a>

    <nav
      class="hidden items-center gap-1 text-sm font-medium md:flex lg:gap-2 lg:text-base"
      aria-label="Primary"
    >
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class:list={[
              'relative rounded-lg px-3 py-2 transition-all focus-visible:outline-none lg:px-4 lg:py-2.5',
              transparent
                ? 'text-white/90 hover:bg-white/10 hover:text-white'
                : 'text-muted hover:bg-brand-50 hover:text-brand-700 dark:hover:bg-surface-muted/30 dark:hover:text-brand-300',
              isActive(item.href)
                ? transparent
                  ? 'bg-white/10 text-white'
                  : 'bg-brand-50 text-brand-700 dark:bg-surface-muted/30 dark:text-brand-300'
                : '',
            ]}
            aria-current={isActive(item.href) ? 'page' : undefined}
          >
            {item.label}
          </a>
        ))
      }
    </nav>

    <div class="flex items-center gap-1.5 sm:gap-2">
      <a
        class:list={[
          'btn-secondary hidden sm:inline-flex',
          transparent
            ? 'border-white/25 bg-white/10 text-white hover:border-white/30 hover:bg-white/15 hover:text-white'
            : '',
        ]}
        href={telHref}
        aria-label={`Call ${siteConfig.contact.phoneDisplay}`}
      >
        {siteConfig.contact.phoneDisplay}
      </a>
      <a
        class:list={['icon-btn sm:hidden', transparent ? 'text-white hover:bg-white/10' : '']}
        href={telHref}
        aria-label={`Call ${siteConfig.contact.phoneDisplay}`}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="h-5 w-5"
          aria-hidden="true"
        >
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.08 4.18 2 2 0 0 1 4.06 2h3a2 2 0 0 1 2 1.72c.12.86.3 1.7.54 2.51a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.57-1.06a2 2 0 0 1 2.11-.45c.81.24 1.65.42 2.51.54A2 2 0 0 1 22 16.92z"
          ></path>
        </svg>
      </a>

      <a class="btn-primary px-3 sm:px-6" href={href('contact/')}>
        <span class="sm:hidden">Quote</span>
        <span class="hidden sm:inline">Request a quote</span>
      </a>

      <details class="relative md:hidden" data-mobile-menu>
        <summary
          class:list={[
            'icon-btn cursor-pointer list-none',
            transparent ? 'text-white hover:bg-white/10' : '',
          ]}
          aria-label="Open menu"
          aria-controls="mobile-menu-panel"
          aria-expanded="false"
          data-menu-summary
        >
          <span class="sr-only">Open menu</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            class="h-5 w-5"
            aria-hidden="true"
          >
            <path d="M4 7h16"></path>
            <path d="M4 12h16"></path>
            <path d="M4 17h16"></path>
          </svg>
        </summary>
        <button type="button" class="mobile-menu-overlay" aria-label="Close menu" data-menu-close
        ></button>
        <div
          class="mobile-menu-panel glass-panel border-l border-white/20"
          id="mobile-menu-panel"
          role="dialog"
          aria-label="Menu"
          aria-modal="true"
        >
          <div class="flex items-center justify-between gap-3 border-b border-white/10 p-3">
            <p class="text-strong text-sm font-semibold">Menu</p>
            <button type="button" class="icon-btn" aria-label="Close menu" data-menu-close>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="h-5 w-5"
                aria-hidden="true"
              >
                <path d="M18 6L6 18"></path>
                <path d="M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <nav class="grid gap-1 p-3" aria-label="Mobile">
            {
              navItems.map((item) => (
                <a
                  href={item.href}
                  class:list={[
                    'block rounded-lg px-3 py-2.5 text-base font-medium transition-colors hover:bg-brand-50 hover:text-brand-700 dark:hover:bg-white/10 dark:hover:text-brand-300',
                    isActive(item.href)
                      ? 'bg-brand-50 text-brand-700 dark:bg-white/10 dark:text-brand-300'
                      : 'text-muted',
                  ]}
                  aria-current={isActive(item.href) ? 'page' : undefined}
                >
                  {item.label}
                </a>
              ))
            }
          </nav>
          <div class="grid grid-cols-2 gap-2 border-t border-white/10 p-3">
            <button
              type="button"
              class="flex items-center justify-center gap-2 rounded-lg bg-[rgb(var(--color-surface))] px-3 py-2.5 text-xs font-medium text-[rgb(var(--color-text))] transition-colors hover:bg-[rgb(var(--color-surface-muted))] dark:bg-[rgb(var(--color-surface))] dark:text-[rgb(var(--color-text))] dark:hover:bg-[rgb(var(--color-surface-muted))]"
              data-theme-toggle
              aria-label="Change theme"
            >
              <span class="sr-only">Theme</span>
              Theme
            </button>
            <button
              type="button"
              class="flex items-center justify-center gap-2 rounded-lg bg-[rgb(var(--color-surface))] px-3 py-2.5 text-xs font-medium text-[rgb(var(--color-text))] transition-colors hover:bg-[rgb(var(--color-surface-muted))] dark:bg-[rgb(var(--color-surface))] dark:text-[rgb(var(--color-text))] dark:hover:bg-[rgb(var(--color-surface-muted))]"
              data-mode-toggle
              aria-label="Change color mode"
            >
              <span class="sr-only">Mode</span>
              Mode
            </button>
          </div>
        </div>
      </details>
    </div>
  </div>
</header>

<script>
  (() => {
    const menu = document.querySelector('details[data-mobile-menu]') as HTMLDetailsElement | null;
    if (!menu) return;
    if (menu.dataset.menuInit === 'true') return;
    menu.dataset.menuInit = 'true';

    const summary = menu.querySelector('[data-menu-summary]') as HTMLElement | null;
    const panel = menu.querySelector('#mobile-menu-panel') as HTMLElement | null;
    const overlayBtn = menu.querySelector(
      'button.mobile-menu-overlay[data-menu-close]'
    ) as HTMLButtonElement | null;
    const closeBtns = Array.from(
      menu.querySelectorAll<HTMLButtonElement>('button[data-menu-close]')
    );

    let lastFocused: HTMLElement | null = null;
    let locked = false;
    let scrollY = 0;
    const prevBodyStyle = {
      position: document.body.style.position,
      top: document.body.style.top,
      width: document.body.style.width,
    };

    const setExpanded = (open: boolean) => {
      summary?.setAttribute('aria-expanded', open ? 'true' : 'false');
    };

    const focusableSelector =
      'a[href],button:not([disabled]),input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex="-1"])';

    const togglePanelTabbables = (enable: boolean) => {
      if (!panel) return;
      const nodes = Array.from(panel.querySelectorAll<HTMLElement>(focusableSelector));
      const sentinel = '__unset__';

      nodes.forEach((el) => {
        if (enable) {
          const prev = el.dataset.prevTabindex;
          if (prev === undefined) return;

          if (prev === sentinel) {
            el.removeAttribute('tabindex');
          } else {
            el.setAttribute('tabindex', prev);
          }
          delete el.dataset.prevTabindex;
          return;
        }

        if (el.dataset.prevTabindex !== undefined) return;
        el.dataset.prevTabindex = el.getAttribute('tabindex') ?? sentinel;
        el.setAttribute('tabindex', '-1');
      });
    };

    const setDialogA11y = (open: boolean) => {
      if (!panel) return;
      if (open) {
        panel.removeAttribute('aria-hidden');
        panel.removeAttribute('inert');
        // `inert` isn't supported everywhere. Restore tabbables as a fallback.
        togglePanelTabbables(true);
        return;
      }
      panel.setAttribute('aria-hidden', 'true');
      // Prevent tab focus into a visually-hidden dialog.
      // Supported in modern Chromium/Safari/Firefox; ignored elsewhere.
      panel.setAttribute('inert', '');
      // Fallback for browsers without `inert`: remove descendants from tab order.
      togglePanelTabbables(false);
    };

    // Used by the swipe-to-close gesture: we temporarily set inline transform/opacity/transition.
    // If the menu closes via overlay/ESC/button mid-gesture, clear those inline overrides.
    const resetPanelInlineStyles = () => {
      if (!panel) return;
      panel.style.transition = '';
      panel.style.transform = '';
      panel.style.opacity = '';
    };

    const lockScroll = () => {
      if (locked) return;
      locked = true;
      scrollY = window.scrollY || 0;
      document.documentElement.dataset.scrollLock = 'true';
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollY}px`;
      document.body.style.width = '100%';
    };

    const unlockScroll = () => {
      if (!locked) return;
      locked = false;
      document.documentElement.dataset.scrollLock = '';
      if (document.documentElement.dataset.scrollLock === '') {
        delete document.documentElement.dataset.scrollLock;
      }
      document.body.style.position = prevBodyStyle.position;
      document.body.style.top = prevBodyStyle.top;
      document.body.style.width = prevBodyStyle.width;
      window.scrollTo(0, scrollY);
    };

    const getFocusables = () => {
      if (!panel) return [] as HTMLElement[];
      const nodes = Array.from(panel.querySelectorAll<HTMLElement>(focusableSelector));
      return nodes.filter((el) => el.offsetParent !== null || el.getClientRects().length > 0);
    };

    const close = () => {
      menu.open = false;
    };
    overlayBtn?.addEventListener('click', close);
    closeBtns.forEach((b) => b.addEventListener('click', close));

    const links = Array.from(menu.querySelectorAll<HTMLAnchorElement>('a[href]'));
    links.forEach((a) => a.addEventListener('click', close));

    menu.addEventListener('toggle', () => {
      setExpanded(menu.open);
      setDialogA11y(menu.open);

      if (menu.open) {
        lastFocused = (document.activeElement as HTMLElement | null) ?? summary;
        lockScroll();
        const focusables = getFocusables();
        (focusables[0] ?? overlayBtn ?? summary)?.focus();
      } else {
        resetPanelInlineStyles();
        unlockScroll();
        // Restore focus to the control that opened the menu.
        (lastFocused ?? summary)?.focus?.();
        lastFocused = null;
      }
    });

    document.addEventListener('keydown', (e) => {
      if (!menu.open) return;
      if (e.key === 'Escape') close();

      if (e.key === 'Tab') {
        const focusables = getFocusables();
        if (!focusables.length) return;

        const first = focusables[0]!;
        const last = focusables[focusables.length - 1]!;
        const active = document.activeElement as HTMLElement | null;

        if (e.shiftKey) {
          if (!active || active === first) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if (active === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
    });

    const mq = window.matchMedia('(min-width: 768px)');
    const handleMQ = () => {
      if (mq.matches && menu.open) close();
    };
    if ('addEventListener' in mq) {
      mq.addEventListener('change', handleMQ);
    } else {
      // Safari < 14 legacy API
      const legacy = mq as unknown as {
        addListener?: (callback: (this: MediaQueryList, ev: MediaQueryListEvent) => void) => void;
      };
      legacy.addListener?.(handleMQ);
    }

    // Initialize state.
    setExpanded(menu.open);
    setDialogA11y(menu.open);

    // --- Swipe to close (touch devices) ---
    // Drag the panel to the right to dismiss. Keeps it subtle and doesn't break scrolling.
    if (panel && typeof window !== 'undefined') {
      let startX = 0;
      let startY = 0;
      let dragging = false;

      const onTouchStart = (e: TouchEvent) => {
        if (!menu.open) return;
        const t = e.touches[0];
        if (!t) return;
        startX = t.clientX;
        startY = t.clientY;
        dragging = false;
        resetPanelInlineStyles();
      };

      const onTouchMove = (e: TouchEvent) => {
        if (!menu.open) return;
        const t = e.touches[0];
        if (!t) return;

        const dx = t.clientX - startX;
        const dy = t.clientY - startY;

        // Only treat as a gesture when it's clearly horizontal and moving right.
        if (dx <= 0) return;
        if (Math.abs(dx) < Math.abs(dy)) return;

        dragging = true;
        panel.style.transition = 'none';

        // Clamp drag distance to panel width.
        const w = Math.max(1, panel.getBoundingClientRect().width);
        const clamped = Math.min(dx, w);
        const progress = clamped / w;
        panel.style.transform = `translateX(${clamped}px)`;
        panel.style.opacity = String(Math.max(0.35, 1 - progress * 0.75));

        // Prevent the page from scrolling while we drag-dismiss.
        e.preventDefault();
      };

      const onTouchEnd = () => {
        if (!menu.open) return;
        if (!dragging) return;

        const w = Math.max(1, panel.getBoundingClientRect().width);
        // If the panel moved far enough, dismiss.
        const current = panel.style.transform;
        const m = /translateX\(([-\d.]+)px\)/.exec(current);
        const dx = m ? Number(m[1]) : 0;

        if (dx > Math.min(140, w * 0.35)) {
          // Animate out a bit then close.
          panel.style.transition =
            'transform 140ms cubic-bezier(0.4, 0, 0.2, 1), opacity 140ms cubic-bezier(0.4, 0, 0.2, 1)';
          panel.style.transform = `translateX(${w}px)`;
          panel.style.opacity = '0';
          window.setTimeout(() => close(), 120);
        } else {
          // Snap back.
          panel.style.transition =
            'transform 160ms cubic-bezier(0.4, 0, 0.2, 1), opacity 160ms cubic-bezier(0.4, 0, 0.2, 1)';
          panel.style.transform = 'translateX(0px)';
          panel.style.opacity = '1';
          window.setTimeout(() => resetPanelInlineStyles(), 170);
        }
      };

      panel.addEventListener('touchstart', onTouchStart, { passive: true });
      panel.addEventListener('touchmove', onTouchMove, { passive: false });
      panel.addEventListener('touchend', onTouchEnd, { passive: true });
      panel.addEventListener('touchcancel', onTouchEnd, { passive: true });
    }
  })();
</script>

<script>
  (() => {
    const root = document.documentElement;
    if (root.dataset.headerScrollInit === 'true') return;
    root.dataset.headerScrollInit = 'true';

    const getHeader = () =>
      document.querySelector('header[data-site-header]') as HTMLElement | null;

    let raf = 0;
    const update = () => {
      raf = 0;
      const header = getHeader();
      if (!header) return;
      header.classList.toggle('is-scrolled', (window.scrollY || 0) > 8);

      // Keep anchor offsets in sync with the *actual* rendered header height.
      const h = Math.ceil(header.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--header-sticky', `${h}px`);
    };

    const onUpdateRequest = () => {
      if (raf) return;
      raf = window.requestAnimationFrame(update);
    };

    update();
    window.addEventListener('scroll', onUpdateRequest, { passive: true });
    window.addEventListener('resize', onUpdateRequest);
    document.addEventListener('astro:page-load', onUpdateRequest);
  })();
</script>

<script>
  (() => {
    const btns = Array.from(document.querySelectorAll<HTMLButtonElement>('[data-mode-toggle]'));
    if (!btns.length) return;

    const modes = ['auto', 'light', 'dark'];

    const getCurrent = () => {
      const current = document.documentElement.dataset.mode;
      return current && modes.includes(current) ? current : 'auto';
    };

    const setMode = (m: string) => {
      document.documentElement.dataset.mode = m;
      try {
        localStorage.setItem('mode', m);
      } catch {
        // ignore
      }

      // Re-sync effective mode (especially important for `auto`).
      try {
        window.dispatchEvent(new Event('damra:mode-change'));
      } catch {
        // ignore
      }

      const label = m === 'auto' ? 'Mode: Auto' : `Mode: ${m}`;
      btns.forEach((b) => {
        const isIcon = b.classList.contains('icon-btn');
        // Keep desktop buttons compact; show full label in the mobile menu.
        if (!isIcon) b.textContent = label;
        b.setAttribute('aria-label', label);
        b.setAttribute('title', label);
      });
    };

    const cycle = () => {
      const current = getCurrent();
      const nextIndex = (modes.indexOf(current) + 1) % modes.length;
      const next = modes[nextIndex] ?? 'auto';
      setMode(next);
    };

    setMode(getCurrent());
    btns.forEach((b) => {
      if (b.dataset.modeToggleInit === 'true') return;
      b.dataset.modeToggleInit = 'true';
      b.addEventListener('click', cycle);
    });
  })();
</script>

<script>
  (() => {
    const btns = Array.from(document.querySelectorAll<HTMLButtonElement>('[data-theme-toggle]'));
    if (!btns.length) return;

    const themes = ['teal', 'navy', 'emerald', 'slate'];

    const getCurrent = () => {
      const current = document.documentElement.dataset.theme;
      return current && themes.includes(current) ? current : 'teal';
    };

    const prettyName = (t: string) => {
      if (t === 'teal') return 'Theme: Teal';
      if (t === 'navy') return 'Theme: Navy';
      if (t === 'emerald') return 'Theme: Emerald';
      if (t === 'slate') return 'Theme: Slate';
      return `Theme: ${t}`;
    };

    const setTheme = (t: string) => {
      document.documentElement.dataset.theme = t;
      try {
        localStorage.setItem('theme', t);
      } catch {
        // ignore
      }
      const label = prettyName(t);
      btns.forEach((b) => {
        const isIcon = b.classList.contains('icon-btn');
        if (!isIcon) b.textContent = label;
        b.setAttribute('aria-label', label);
        b.setAttribute('title', label);
      });
    };

    const cycle = () => {
      const current = getCurrent();
      const nextIndex = (themes.indexOf(current) + 1) % themes.length;
      const next = themes[nextIndex] ?? 'navy';
      setTheme(next);
    };

    setTheme(getCurrent());
    btns.forEach((b) => {
      if (b.dataset.themeToggleInit === 'true') return;
      b.dataset.themeToggleInit = 'true';
      b.addEventListener('click', cycle);
    });
  })();
</script>

<style>
  header.header-transparent:not(.is-scrolled) {
    background-color: transparent;
    border-color: transparent;
  }
</style>
