---
import { siteConfig } from '@/data/siteConfig';

type Props = {
  id?: string;
  heading?: string;
  description?: string;
};

const {
  id,
  heading = 'Get a fast quote',
  description = 'Share a few details about your space and schedule. We’ll confirm scope, timing, and next steps—then send a clear quote.',
} = Astro.props;

const formEndpoint = import.meta.env.PUBLIC_FORM_ENDPOINT;
const telHref = `tel:${siteConfig.contact.phoneE164}`;
const mailtoTo = siteConfig.contact.email;
const sourcePath = Astro.url.pathname;
---

<section id={id} class="section section-muted section-creative scroll-mt-20">
  <div class="container-page relative">
    <div aria-hidden="true" class="pointer-events-none absolute inset-x-0 -top-14 -z-10">
      <div class="mx-auto h-72 w-[min(74rem,96vw)] rounded-full bg-brand-500/10 blur-3xl"></div>
    </div>

    <div class="grid gap-10 lg:grid-cols-2">
      <div>
        <h2 class="heading-2">{heading}</h2>
        <p class="lede">{description}</p>

        <div class="text-muted mt-6 space-y-3 text-sm">
          <p>
            <span class="text-strong font-semibold">Call/Text:</span>
            <a class="underline decoration-brand-300/50 underline-offset-4" href={telHref}>
              {siteConfig.contact.phoneDisplay}
            </a>
          </p>
          <p>
            <span class="text-strong font-semibold">Email:</span>
            <a
              class="underline decoration-brand-300/50 underline-offset-4"
              href={`mailto:${siteConfig.contact.email}`}
            >
              {siteConfig.contact.email}
            </a>
          </p>
          <div>
            <p class="text-strong font-semibold">Hours</p>
            <ul class="mt-1 grid gap-1">
              {siteConfig.hours.lines.map((h) => <li>{h}</li>)}
            </ul>
          </div>
        </div>

        <div class="glass-panel relative mt-8 overflow-hidden p-6">
          <div
            aria-hidden="true"
            class="from-brand-200/16 to-brand-300/12 pointer-events-none absolute inset-0 bg-gradient-to-br via-transparent"
          >
          </div>
          <div class="relative">
            <p class="text-strong text-sm font-semibold">What happens next</p>
            <ol class="text-muted mt-2 grid gap-2 text-sm">
              <li>
                <span class="text-strong font-semibold">1.</span> We reply within 1 business day.
              </li>
              <li>
                <span class="text-strong font-semibold">2.</span> We confirm scope, access, and any special
                requirements.
              </li>
              <li>
                <span class="text-strong font-semibold">3.</span> You get a clear, written quote.
              </li>
            </ol>

            <p class="text-subtle mt-3 text-xs">
              This form includes a hidden anti-spam field. We only use your details to respond to
              your request.
            </p>
          </div>
        </div>
      </div>

      <div class="glass-card relative overflow-hidden p-6 sm:p-7">
        <div
          aria-hidden="true"
          class="from-brand-200/16 to-brand-300/12 pointer-events-none absolute inset-0 bg-gradient-to-br via-transparent"
        >
        </div>
        <div class="relative">
          {
            !formEndpoint && (
              <div class="mb-4 rounded-xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900">
                <p class="font-semibold">Form endpoint not configured</p>
                <p class="mt-1">
                  Set <code class="rounded bg-white px-1.5 py-0.5">PUBLIC_FORM_ENDPOINT</code> in{' '}
                  <code class="rounded bg-white px-1.5 py-0.5">.env</code>
                  (see <code class="rounded bg-white px-1.5 py-0.5">.env.example</code>) to enable
                  submissions. For now, this form will open your email app with the details filled
                  in.
                </p>
              </div>
            )
          }

          <form
            action={formEndpoint ?? '#'}
            method="POST"
            class="grid gap-4"
            data-contact-form
            data-form-endpoint={formEndpoint ?? ''}
            data-mailto-to={mailtoTo}
            aria-describedby="contact-help"
          >
            <input type="hidden" name="source" value={sourcePath} />

            <p id="contact-help" class="text-muted text-sm">
              Fields marked with <span class="font-semibold">*</span> are required.
            </p>

            <p
              class="text-muted hidden text-sm"
              data-contact-status
              role="status"
              aria-live="polite"
            >
            </p>

            <div class="grid gap-4 sm:grid-cols-2">
              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Company / Organization *</span>
                <input
                  class="input"
                  type="text"
                  name="companyName"
                  autocomplete="organization"
                  autocapitalize="words"
                  required
                />
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Contact name *</span>
                <input
                  class="input"
                  type="text"
                  name="name"
                  autocomplete="name"
                  autocapitalize="words"
                  required
                />
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Email *</span>
                <input
                  class="input"
                  type="email"
                  name="email"
                  autocomplete="email"
                  inputmode="email"
                  required
                />
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Phone</span>
                <input class="input" type="tel" name="phone" autocomplete="tel" inputmode="tel" />
              </label>
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Preferred contact</span>
                <select class="select" name="contactMethod">
                  <option value="Email">Email</option>
                  <option value="Phone">Phone</option>
                  <option value="Text">Text</option>
                </select>
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Location (City + ZIP) *</span>
                <input
                  class="input"
                  type="text"
                  name="location"
                  autocomplete="postal-code"
                  required
                  placeholder="Example: San Francisco, 94103"
                />
              </label>
            </div>

            <label class="grid gap-1 text-sm">
              <span class="text-strong font-semibold">Service type</span>
              <select class="select" name="service">
                <option value="Office Cleaning">Office Cleaning</option>
                <option value="Recurring Janitorial">Recurring Janitorial</option>
                <option value="Deep / Detail Cleaning">Deep / Detail Cleaning</option>
                <option value="Move-In / Move-Out (Office Turnover)"
                  >Move-In / Move-Out (Office Turnover)</option
                >
                <option value="Post-Construction Cleanup">Post-Construction Cleanup</option>
                <option value="Day Porter / Daytime Upkeep">Day Porter / Daytime Upkeep</option>
                <option value="Supplies & Restocking">Supplies & Restocking</option>
                <option value="Facilities Support">Facilities Support</option>
                <option value="Other">Other / Not sure</option>
              </select>
            </label>

            <div class="grid gap-4 sm:grid-cols-2">
              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Approx. square footage</span>
                <select class="select" name="sqft">
                  <option value="Not sure">Not sure</option>
                  <option value="Under 2,000">Under 2,000</option>
                  <option value="2,000–5,000">2,000–5,000</option>
                  <option value="5,000–10,000">5,000–10,000</option>
                  <option value="10,000–25,000">10,000–25,000</option>
                  <option value="25,000+">25,000+</option>
                </select>
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Cleaning frequency</span>
                <select class="select" name="frequency">
                  <option value="Not sure">Not sure</option>
                  <option value="One-time">One-time</option>
                  <option value="Weekly">Weekly</option>
                  <option value="2–3x / week">2–3x / week</option>
                  <option value="Daily">Daily</option>
                  <option value="Day porter">Day porter</option>
                  <option value="Custom">Custom</option>
                </select>
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Building type</span>
                <select class="select" name="buildingType">
                  <option value="Office">Office</option>
                  <option value="Medical">Medical / Clinic</option>
                  <option value="Retail">Retail</option>
                  <option value="Warehouse">Warehouse / Industrial</option>
                  <option value="Education">Education</option>
                  <option value="Other">Other</option>
                </select>
              </label>

              <label class="grid gap-1 text-sm">
                <span class="text-strong font-semibold">Access window</span>
                <select class="select" name="accessWindow">
                  <option value="Business hours">Business hours</option>
                  <option value="After-hours">After-hours</option>
                  <option value="Weekends">Weekends</option>
                  <option value="Flexible">Flexible</option>
                </select>
              </label>

              <label class="grid gap-1 text-sm sm:col-span-2">
                <span class="text-strong font-semibold">Timing</span>
                <select class="select" name="startTiming">
                  <option value="ASAP">ASAP</option>
                  <option value="Within 2 weeks">Within 2 weeks</option>
                  <option value="Within a month">Within a month</option>
                  <option value="Just researching">Just researching</option>
                </select>
              </label>
            </div>

            <fieldset class="grid gap-2 text-sm">
              <legend class="text-strong font-semibold">Add-ons (optional)</legend>
              <div class="grid gap-2 sm:grid-cols-2">
                <label class="flex items-start gap-2">
                  <input class="mt-1" type="checkbox" name="extras" value="Restocking" />
                  <span class="text-muted">Supplies / restocking</span>
                </label>
                <label class="flex items-start gap-2">
                  <input class="mt-1" type="checkbox" name="extras" value="Disinfecting" />
                  <span class="text-muted">Disinfecting & high-touch focus</span>
                </label>
                <label class="flex items-start gap-2">
                  <input class="mt-1" type="checkbox" name="extras" value="Floor care" />
                  <span class="text-muted">Floor care (strip/wax, scrubbing)</span>
                </label>
                <label class="flex items-start gap-2">
                  <input class="mt-1" type="checkbox" name="extras" value="Windows" />
                  <span class="text-muted">Interior windows / glass</span>
                </label>
              </div>
            </fieldset>

            <label class="grid gap-1 text-sm">
              <span class="text-strong font-semibold">Notes / scope details *</span>
              <textarea
                class="textarea min-h-28"
                name="message"
                required
                placeholder="Example: ~2,500 sq ft office; weekly after 6pm; focus on restrooms + kitchen; monthly deep clean."
              ></textarea>
            </label>

            {/* Honeypot (bots will often fill this). Keep it visually hidden. */}
            <div class="hidden" aria-hidden="true">
              <label>
                Website
                <input type="text" name="website" tabindex="-1" autocomplete="off" />
              </label>
            </div>

            <button class="btn-primary" type="submit" data-contact-submit>Send request</button>

            <p class="text-subtle text-xs">
              By submitting, you agree to be contacted about your request. No spam—ever.
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (() => {
    const form = document.querySelector('form[data-contact-form]') as HTMLFormElement | null;
    if (!form) return;

    const endpoint = form.dataset.formEndpoint || '';

    const status = form.querySelector('[data-contact-status]') as HTMLElement | null;
    const submitBtn = form.querySelector('[data-contact-submit]') as HTMLButtonElement | null;

    const setStatus = (message: string) => {
      if (!status) return;
      status.textContent = message;
      status.classList.remove('hidden');
    };

    const setBusy = (busy: boolean) => {
      form.setAttribute('aria-busy', busy ? 'true' : 'false');
      if (submitBtn) {
        submitBtn.disabled = busy;
        submitBtn.classList.toggle('opacity-70', busy);
        submitBtn.classList.toggle('cursor-not-allowed', busy);
        submitBtn.textContent = busy ? 'Sending…' : 'Send request';
      }
    };

    const focusFirstInvalid = () => {
      const el = form.querySelector<HTMLElement>(':invalid');
      el?.focus?.();
    };

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const to = form.dataset.mailtoTo || '';
      if (!to) {
        setStatus('Email address not configured. Please call/text instead.');
        return;
      }

      const fd = new FormData(form);
      const source = String(fd.get('source') ?? '').trim();
      const companyName = String(fd.get('companyName') ?? '').trim();
      const name = String(fd.get('name') ?? '').trim();
      const email = String(fd.get('email') ?? '').trim();
      const phone = String(fd.get('phone') ?? '').trim();
      const contactMethod = String(fd.get('contactMethod') ?? '').trim();
      const location = String(fd.get('location') ?? '').trim();
      const service = String(fd.get('service') ?? '').trim();
      const sqft = String(fd.get('sqft') ?? '').trim();
      const frequency = String(fd.get('frequency') ?? '').trim();
      const buildingType = String(fd.get('buildingType') ?? '').trim();
      const accessWindow = String(fd.get('accessWindow') ?? '').trim();
      const startTiming = String(fd.get('startTiming') ?? '').trim();
      const extras = fd
        .getAll('extras')
        .map((v) => String(v).trim())
        .filter(Boolean);
      const message = String(fd.get('message') ?? '').trim();
      const honeypot = String(fd.get('website') ?? '').trim();

      // Simple bot check: if honeypot is filled, do nothing.
      if (honeypot) {
        setStatus('Thanks!');
        return;
      }

      if (!companyName || !name || !email || !location || !message) {
        setStatus(
          'Please fill in the required fields (company, contact name, email, location, and notes).'
        );
        focusFirstInvalid();
        return;
      }

      // If endpoint exists, try an async submission (better UX on mobile).
      if (endpoint && typeof fetch === 'function') {
        setBusy(true);
        setStatus('Sending…');

        fetch(endpoint, {
          method: 'POST',
          body: fd,
          headers: {
            Accept: 'application/json',
          },
        })
          .then(async (res) => {
            if (res.ok) return;

            // Try to parse a helpful error payload.
            let msg = 'Could not send your request. Please try again or call/text.';
            try {
              const data = (await res.json()) as unknown;
              if (
                data &&
                typeof data === 'object' &&
                'error' in data &&
                typeof (data as { error?: unknown }).error === 'string'
              ) {
                msg = (data as { error: string }).error;
              }
            } catch {
              // ignore
            }
            throw new Error(msg);
          })
          .then(() => {
            setStatus('Request received — we’ll reply within 1 business day.');
            form.reset();
          })
          .catch((err: unknown) => {
            const msg = err instanceof Error ? err.message : 'Something went wrong.';
            setStatus(msg);
            // Fallback: attempt a normal submit (if endpoint supports it).
            try {
              form.submit();
            } catch {
              // ignore
            }
          })
          .finally(() => {
            setBusy(false);
          });

        return;
      }

      const subject = `Quote request — ${companyName || name}`;
      const body = [
        source ? `Page: ${source}` : undefined,
        companyName ? `Company: ${companyName}` : undefined,
        `Name: ${name}`,
        `Email: ${email}`,
        phone ? `Phone: ${phone}` : undefined,
        contactMethod ? `Preferred contact: ${contactMethod}` : undefined,
        location ? `Location: ${location}` : undefined,
        service ? `Service: ${service}` : undefined,
        buildingType ? `Building type: ${buildingType}` : undefined,
        sqft ? `Sq ft: ${sqft}` : undefined,
        frequency ? `Frequency: ${frequency}` : undefined,
        accessWindow ? `Access: ${accessWindow}` : undefined,
        startTiming ? `Timing: ${startTiming}` : undefined,
        extras.length ? `Add-ons: ${extras.join(', ')}` : undefined,
        '',
        message,
      ]
        .filter(Boolean)
        .join('\n');

      setStatus('Opening your email app…');
      const href = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = href;
    });
  })();
</script>
