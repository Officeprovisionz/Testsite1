---
import { siteConfig } from '@/data/siteConfig';

const telHref = `tel:${siteConfig.contact.phoneE164}`;

const base = import.meta.env.BASE_URL;
const href = (path: string) => `${base}${path.replace(/^\/+/, '')}`;

const stripHashAndQuery = (path: string) => path.split('#')[0]?.split('?')[0] ?? path;
const normalizeTrailingSlash = (path: string) => {
  const cleaned = stripHashAndQuery(path);
  return cleaned.endsWith('/') ? cleaned : `${cleaned}/`;
};
const currentPath = normalizeTrailingSlash(Astro.url.pathname);
const isActive = (targetHref: string) => {
  const target = normalizeTrailingSlash(targetHref);
  // Home should match exactly; other pages can match by prefix for nested routes.
  const home = normalizeTrailingSlash(base);
  if (target === home) return currentPath === home;
  return currentPath === target || currentPath.startsWith(target);
};

const navItems = [
  { label: 'Home', href: href('') },
  { label: 'Services', href: href('services/') },
  { label: 'Industries', href: href('industries/') },
  { label: 'Pricing', href: href('pricing/') },
  { label: 'Results', href: href('results/') },
  { label: 'About', href: href('about/') },
  { label: 'Contact', href: href('contact/') },
];

const initials = (() => {
  const words = siteConfig.brand.name.trim().split(/\s+/).filter(Boolean);
  const letters = words
    .slice(0, 2)
    .map((w) => w[0]?.toUpperCase())
    .filter(Boolean);
  if (letters.length >= 2) return letters.join('');
  const fallback = siteConfig.brand.name.replace(/\s+/g, '').slice(0, 2).toUpperCase();
  return fallback || 'OP';
})();
---

<header
  class="app-bar sticky top-0 z-40 border-b backdrop-blur-md transition-all duration-300"
  data-site-header
>
  <div class="header-inner container-page flex items-center justify-between">
    <a href={href('')} class="flex items-center gap-3 font-serif text-xl font-bold tracking-tight">
      <span
        class="brand-mark grid place-items-center rounded-lg bg-brand-900 text-white shadow-md shadow-brand-900/20"
      >
        {initials}
      </span>
      <span class="text-strong">{siteConfig.brand.name}</span>
    </a>

    <nav class="hidden items-center gap-6 text-sm font-medium md:flex" aria-label="Primary">
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class:list={[
              'text-muted relative rounded-lg px-2 py-1 hover:text-slate-900/90 focus-visible:outline-none',
              isActive(item.href)
                ? 'text-strong after:absolute after:inset-x-2 after:-bottom-1 after:h-0.5 after:rounded-full after:bg-brand-600'
                : '',
            ]}
            aria-current={isActive(item.href) ? 'page' : undefined}
          >
            {item.label}
          </a>
        ))
      }
    </nav>

    <details class="relative md:hidden" data-mobile-menu>
      <summary
        class="btn-secondary cursor-pointer list-none px-3 py-2"
        aria-label="Open menu"
        aria-controls="mobile-menu-panel"
        aria-expanded="false"
        data-menu-summary
      >
        <span class="text-sm font-semibold">Menu</span>
      </summary>
      <button type="button" class="mobile-menu-overlay" aria-label="Close menu" data-menu-close
      ></button>
      <div class="mobile-menu-panel" id="mobile-menu-panel" role="dialog" aria-label="Menu">
        <nav class="grid" aria-label="Mobile">
          {
            navItems.map((item) => (
              <a
                href={item.href}
                class:list={['menu-link', isActive(item.href) ? 'surface-muted text-strong' : '']}
                aria-current={isActive(item.href) ? 'page' : undefined}
              >
                {item.label}
              </a>
            ))
          }
        </nav>
        <div class="border-app border-t p-2">
          <button
            type="button"
            class="menu-link w-full text-left"
            data-theme-toggle
            aria-label="Change theme"
          >
            Theme
          </button>
          <button
            type="button"
            class="menu-link w-full text-left"
            data-mode-toggle
            aria-label="Change color mode"
          >
            Mode
          </button>
        </div>
      </div>
    </details>

    <div class="flex items-center gap-2">
      <button
        type="button"
        class="icon-btn hidden sm:inline-flex"
        aria-label="Change theme"
        data-theme-toggle
        title="Change theme"
      >
        Theme
      </button>
      <button
        type="button"
        class="icon-btn hidden sm:inline-flex"
        aria-label="Change color mode"
        data-mode-toggle
        title="Change color mode"
      >
        Mode
      </button>
      <a class="btn-secondary hidden sm:inline-flex" href={telHref}>Call/Text</a>
      <a class="btn-primary" href={href('contact/')}>Get a Quote</a>
    </div>
  </div>
</header>

<script>
  (() => {
    const menu = document.querySelector('details[data-mobile-menu]') as HTMLDetailsElement | null;
    if (!menu) return;

    const summary = menu.querySelector('[data-menu-summary]') as HTMLElement | null;
    const panel = menu.querySelector('#mobile-menu-panel') as HTMLElement | null;
    const overlayBtn = menu.querySelector('[data-menu-close]') as HTMLButtonElement | null;

    let lastFocused: HTMLElement | null = null;
    let locked = false;
    let scrollY = 0;
    const prevBodyStyle = {
      position: document.body.style.position,
      top: document.body.style.top,
      width: document.body.style.width,
    };

    const setExpanded = (open: boolean) => {
      summary?.setAttribute('aria-expanded', open ? 'true' : 'false');
    };

    const lockScroll = () => {
      if (locked) return;
      locked = true;
      scrollY = window.scrollY || 0;
      document.documentElement.dataset.scrollLock = 'true';
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollY}px`;
      document.body.style.width = '100%';
    };

    const unlockScroll = () => {
      if (!locked) return;
      locked = false;
      document.documentElement.dataset.scrollLock = '';
      if (document.documentElement.dataset.scrollLock === '') {
        delete document.documentElement.dataset.scrollLock;
      }
      document.body.style.position = prevBodyStyle.position;
      document.body.style.top = prevBodyStyle.top;
      document.body.style.width = prevBodyStyle.width;
      window.scrollTo(0, scrollY);
    };

    const getFocusables = () => {
      if (!panel) return [] as HTMLElement[];
      const nodes = Array.from(
        panel.querySelectorAll<HTMLElement>(
          'a[href],button:not([disabled]),input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex="-1"])'
        )
      );
      return nodes.filter((el) => el.offsetParent !== null || el.getClientRects().length > 0);
    };

    const close = () => {
      menu.open = false;
    };
    overlayBtn?.addEventListener('click', close);

    const links = Array.from(menu.querySelectorAll<HTMLAnchorElement>('a[href]'));
    links.forEach((a) => a.addEventListener('click', close));

    menu.addEventListener('toggle', () => {
      setExpanded(menu.open);

      if (menu.open) {
        lastFocused = (document.activeElement as HTMLElement | null) ?? summary;
        lockScroll();
        const focusables = getFocusables();
        (focusables[0] ?? overlayBtn ?? summary)?.focus();
      } else {
        unlockScroll();
        // Restore focus to the control that opened the menu.
        (lastFocused ?? summary)?.focus?.();
        lastFocused = null;
      }
    });

    document.addEventListener('keydown', (e) => {
      if (!menu.open) return;
      if (e.key === 'Escape') close();

      if (e.key === 'Tab') {
        const focusables = getFocusables();
        if (!focusables.length) return;

        const first = focusables[0]!;
        const last = focusables[focusables.length - 1]!;
        const active = document.activeElement as HTMLElement | null;

        if (e.shiftKey) {
          if (!active || active === first) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if (active === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
    });

    const mq = window.matchMedia('(min-width: 768px)');
    const handleMQ = () => {
      if (mq.matches && menu.open) close();
    };
    if ('addEventListener' in mq) {
      mq.addEventListener('change', handleMQ);
    } else {
      // Safari < 14 legacy API
      (mq as unknown as { addListener: (cb: () => void) => void }).addListener(handleMQ);
    }

    // Initialize state.
    setExpanded(menu.open);
  })();
</script>

<script>
  (() => {
    const header = document.querySelector('header[data-site-header]') as HTMLElement | null;
    if (!header) return;

    let raf = 0;
    const update = () => {
      raf = 0;
      header.classList.toggle('is-scrolled', (window.scrollY || 0) > 8);

      // Keep anchor offsets in sync with the *actual* rendered header height.
      const h = Math.ceil(header.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--header-sticky', `${h}px`);
    };

    const onUpdateRequest = () => {
      if (raf) return;
      raf = window.requestAnimationFrame(update);
    };

    update();
    window.addEventListener('scroll', onUpdateRequest, { passive: true });
    window.addEventListener('resize', onUpdateRequest);
  })();
</script>

<script>
  (() => {
    const btns = Array.from(document.querySelectorAll<HTMLButtonElement>('[data-mode-toggle]'));
    if (!btns.length) return;

    const modes = ['auto', 'light', 'dark'] as const;
    type Mode = (typeof modes)[number];

    const getCurrent = (): Mode => {
      const current = document.documentElement.dataset.mode as Mode | undefined;
      return current && modes.includes(current) ? current : 'auto';
    };

    const setMode = (m: Mode) => {
      document.documentElement.dataset.mode = m;
      try {
        localStorage.setItem('mode', m);
      } catch {
        // ignore
      }
      const label = m === 'auto' ? 'Mode: Auto' : `Mode: ${m}`;
      btns.forEach((b) => (b.textContent = label));
    };

    const cycle = () => {
      const current = getCurrent();
      const nextIndex = (modes.indexOf(current) + 1) % modes.length;
      const next = modes[nextIndex] ?? 'auto';
      setMode(next);
    };

    setMode(getCurrent());
    btns.forEach((b) => b.addEventListener('click', cycle));
  })();
</script>

<script>
  (() => {
    const btns = Array.from(document.querySelectorAll<HTMLButtonElement>('[data-theme-toggle]'));
    if (!btns.length) return;

    const themes = ['navy', 'emerald', 'slate'] as const;
    type Theme = (typeof themes)[number];

    const getCurrent = (): Theme => {
      const current = document.documentElement.dataset.theme as Theme | undefined;
      return current && themes.includes(current) ? current : 'navy';
    };

    const setTheme = (t: Theme) => {
      document.documentElement.dataset.theme = t;
      try {
        localStorage.setItem('theme', t);
      } catch {
        // ignore
      }
      const label = t === 'navy' ? 'Theme: Navy' : `Theme: ${t}`;
      btns.forEach((b) => (b.textContent = label));
    };

    const cycle = () => {
      const current = getCurrent();
      const nextIndex = (themes.indexOf(current) + 1) % themes.length;
      const next = themes[nextIndex] ?? 'navy';
      setTheme(next);
    };

    setTheme(getCurrent());
    btns.forEach((b) => b.addEventListener('click', cycle));
  })();
</script>
