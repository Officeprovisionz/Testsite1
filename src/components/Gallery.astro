---
import { galleryItems } from '@/data/gallery';

type Props = {
  id?: string;
  heading?: string;
  description?: string;
};

const {
  id,
  heading = 'Gallery',
  description = 'A quick look at the spaces we support. Replace these placeholders with your own photos.',
} = Astro.props;

const base = import.meta.env.BASE_URL;

const toPublicUrl = (src: string) => {
  // Allow absolute URLs
  if (/^https?:\/\//i.test(src)) return src;
  // Allow absolute-to-domain paths (we still want BASE_URL on GitHub Pages)
  const cleaned = src.replace(/^\/+/, '');
  return `${base}${cleaned}`;
};
---

<section id={id} class="section scroll-mt-20">
  <div class="container-page">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h2 class="text-3xl font-extrabold tracking-tight text-slate-900">{heading}</h2>
        <p class="mt-2 max-w-prose text-slate-700">{description}</p>
      </div>
      <p class="text-sm text-slate-600">
        Tip: add images to <code class="rounded bg-slate-100 px-1.5 py-0.5">public/gallery</code>.
      </p>
    </div>

    <div class="mt-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-3" data-gallery>
      {
        galleryItems.map((it, idx) => (
          <a
            href={toPublicUrl(it.src)}
            class="card group overflow-hidden"
            data-gallery-item
            data-gallery-index={String(idx)}
          >
            <div class="relative aspect-[4/3] bg-slate-100">
              <img
                src={toPublicUrl(it.src)}
                alt={it.alt}
                loading="lazy"
                decoding="async"
                class="h-full w-full object-cover transition duration-300 group-hover:scale-[1.02]"
              />
            </div>
            <div class="p-5">
              <p class="text-sm font-semibold text-slate-900">{it.caption ?? 'Project photo'}</p>
              <p class="mt-1 text-sm text-slate-700">{it.alt}</p>
            </div>
          </a>
        ))
      }
    </div>

    <dialog
      class="w-full max-w-3xl rounded-2xl border border-slate-200 bg-white p-0 shadow-soft"
      data-lightbox
    >
      <div class="flex items-center justify-between border-b border-slate-200 px-5 py-4">
        <p class="text-sm font-semibold text-slate-900" data-lightbox-title>Preview</p>
        <button type="button" class="btn-secondary px-3 py-2" data-close>Close</button>
      </div>
      <figure class="grid gap-3 p-5">
        <img
          data-lightbox-img
          alt=""
          class="w-full rounded-xl border border-slate-200 bg-slate-50 object-contain"
        />
        <figcaption class="text-sm text-slate-700" data-lightbox-caption></figcaption>
      </figure>
    </dialog>
  </div>

  <script>
    (() => {
      const root = document.querySelector('[data-gallery]');
      if (!root) return;

      const links = Array.from(root.querySelectorAll('a[data-gallery-item]'));
      const dialog = document.querySelector('dialog[data-lightbox]') as HTMLDialogElement | null;
      if (!dialog) return;

      const img = dialog.querySelector('[data-lightbox-img]') as HTMLImageElement | null;
      const caption = dialog.querySelector('[data-lightbox-caption]') as HTMLElement | null;
      const title = dialog.querySelector('[data-lightbox-title]') as HTMLElement | null;
      const closeBtn = dialog.querySelector('[data-close]') as HTMLButtonElement | null;

      const setContent = (href: string, text: string) => {
        if (img) img.src = href;
        if (caption) caption.textContent = text || '';
        if (title) title.textContent = 'Photo preview';
      };

      const open = (href: string, text: string) => {
        setContent(href, text);
        if (typeof dialog.showModal === 'function') dialog.showModal();
        else dialog.setAttribute('open', '');
      };

      const close = () => {
        if (typeof dialog.close === 'function') dialog.close();
        else dialog.removeAttribute('open');
      };

      links.forEach((a) => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const href = a.getAttribute('href') || '';
          const text = a.querySelector('p')?.textContent || '';
          open(href, text);
        });
      });

      closeBtn?.addEventListener('click', close);
      dialog.addEventListener('click', (e) => {
        // Click outside the modal content closes it.
        if (e.target === dialog) close();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && dialog.hasAttribute('open')) close();
      });
    })();
  </script>
</section>
