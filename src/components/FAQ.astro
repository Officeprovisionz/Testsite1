---
import { getCollection } from 'astro:content';
import WaveDivider from '@/components/WaveDivider.astro';
import SectionHeader from '@/components/ui/SectionHeader.astro';

type Props = {
  id?: string;
  heading?: string;
  description?: string;
  showWave?: boolean;
};

const {
  id = 'faq',
  heading = 'FAQ',
  description = 'Quick answers to common questions.',
  showWave = true,
} = Astro.props;

const faqs = await getCollection('faqs');
const items = faqs.map((f) => f.data);

const faqJsonLd = (() => {
  const data = {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: items.map((it) => ({
      '@type': 'Question',
      name: it.question,
      acceptedAnswer: {
        '@type': 'Answer',
        text: it.answer,
      },
    })),
  };

  // Prevent accidental "</script>" injection via safe escaping.
  return JSON.stringify(data).replace(/</g, '\\u003c');
})();
---

<section id={id} class="section scroll-mt-20">
  <script type="application/ld+json" is:inline set:html={faqJsonLd} />
  <div class="container-page relative">
    <SectionHeader eyebrow="FAQ" heading={heading} description={description} />

    <div class="mx-auto mt-10 max-w-3xl space-y-3 lg:mt-14 lg:max-w-4xl" data-faq>
      {
        items.map((it) => (
          <details
            class="bg-surface/92 open:shadow-brand/8 border-brand/20 open:border-brand/40 hover:border-brand/30 hover:shadow-brand/5 dark:border-brand/20 dark:open:border-brand/40 dark:open:shadow-brand/10 dark:hover:border-brand/30 group overflow-hidden rounded-2xl border shadow-sm backdrop-blur-sm transition-all duration-300 ease-out open:shadow-lg hover:shadow-md"
            data-faq-item
          >
            <summary class="text-strong hover:bg-brand/5 active:bg-brand/10 flex w-full cursor-pointer list-none items-center justify-between gap-4 px-5 py-5 text-left font-medium transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[rgb(var(--color-brand)/0.5)] focus-visible:ring-offset-2 lg:px-7 lg:py-5 lg:text-lg">
              <span>{it.question}</span>
              <svg
                class="text-brand group-open:text-brand h-5 w-5 shrink-0 transition-all duration-300 [transition-timing-function:cubic-bezier(0.34,1.56,0.64,1)] group-open:rotate-180"
                aria-hidden="true"
                data-faq-icon
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2.5"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="border-brand/10 border-t bg-surface-muted/30 px-5 py-5 text-sm leading-relaxed text-muted lg:px-7 lg:py-5 lg:text-base lg:leading-relaxed">
              <p>{it.answer}</p>
            </div>
          </details>
        ))
      }
    </div>
  </div>

  {
    showWave ? (
      <div class="relative -mb-px mt-12">
        <WaveDivider tone="surface-muted" class="absolute bottom-0 left-0 right-0" />
      </div>
    ) : null
  }

  <script>
    (() => {
      const init = () => {
        const root = document.querySelector('[data-faq]') as HTMLElement | null;
        if (!root) return;
        if (root.dataset.faqInit === 'true') return;
        root.dataset.faqInit = 'true';

        const items = Array.from(root.querySelectorAll<HTMLDetailsElement>('[data-faq-item]'));

        items.forEach((el) => {
          el.addEventListener('toggle', () => {
            // Keep it "dropdown" style: only one open at a time.
            if (el.open) items.forEach((other) => other !== el && (other.open = false));
          });
        });
      };

      const doc = document.documentElement;
      if (doc.dataset.faqListen !== 'true') {
        doc.dataset.faqListen = 'true';
        document.addEventListener('astro:page-load', init);
      }

      init();
    })();
  </script>
</section>

<style>
  /* Remove the default disclosure triangle marker for a cleaner dropdown look. */
  summary::-webkit-details-marker {
    display: none;
  }
</style>
