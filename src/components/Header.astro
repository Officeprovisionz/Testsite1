---
import { siteConfig } from '@/data/siteConfig';

const telHref = `tel:${siteConfig.contact.phoneE164}`;

const base = import.meta.env.BASE_URL;
const href = (path: string) => `${base}${path.replace(/^\/+/, '')}`;

const normalizeTrailingSlash = (path: string) => (path.endsWith('/') ? path : `${path}/`);
const currentPath = normalizeTrailingSlash(Astro.url.pathname);
const isActive = (targetHref: string) => {
  const target = normalizeTrailingSlash(targetHref);
  // Home should match exactly; other pages can match by prefix for nested routes.
  const home = normalizeTrailingSlash(base);
  if (target === home) return currentPath === home;
  return currentPath === target || currentPath.startsWith(target);
};

const navItems = [
  { label: 'Home', href: href('') },
  { label: 'Services', href: href('services/') },
  { label: 'About', href: href('about/') },
  { label: 'Gallery', href: href('about/#gallery') },
  { label: 'Contact', href: href('contact/') },
];

const initials = (() => {
  const words = siteConfig.brand.name.trim().split(/\s+/).filter(Boolean);
  const letters = words
    .slice(0, 2)
    .map((w) => w[0]?.toUpperCase())
    .filter(Boolean);
  if (letters.length >= 2) return letters.join('');
  const fallback = siteConfig.brand.name.replace(/\s+/g, '').slice(0, 2).toUpperCase();
  return fallback || 'OP';
})();
---

<header class="sticky top-0 z-40 border-b border-slate-200 bg-white/80 backdrop-blur">
  <div class="container-page flex h-16 items-center justify-between">
    <a href={href('')} class="flex items-center gap-2 font-extrabold tracking-tight">
      <span class="grid h-9 w-9 place-items-center rounded-xl bg-brand-600 text-white">
        {initials}
      </span>
      <span class="text-slate-900">{siteConfig.brand.name}</span>
    </a>

    <nav
      class="hidden items-center gap-6 text-sm font-medium text-slate-700 md:flex"
      aria-label="Primary"
    >
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class:list={[
              'relative rounded-lg px-2 py-1 hover:text-slate-900 focus-visible:outline-none',
              isActive(item.href)
                ? 'text-slate-900 after:absolute after:inset-x-2 after:-bottom-1 after:h-0.5 after:rounded-full after:bg-brand-600'
                : 'text-slate-700',
            ]}
            aria-current={isActive(item.href) ? 'page' : undefined}
          >
            {item.label}
          </a>
        ))
      }
    </nav>

    <details class="relative md:hidden" data-mobile-menu>
      <summary class="btn-secondary cursor-pointer list-none px-3 py-2" aria-label="Open menu">
        <span class="text-sm font-semibold">Menu</span>
      </summary>
      <button type="button" class="mobile-menu-overlay" aria-label="Close menu" data-menu-close
      ></button>
      <div class="mobile-menu-panel">
        <nav class="grid" aria-label="Mobile">
          {
            navItems.map((item) => (
              <a
                href={item.href}
                class:list={[
                  'px-4 py-3.5 text-sm font-medium hover:bg-slate-50',
                  isActive(item.href) ? 'bg-slate-50 text-slate-900' : 'text-slate-700',
                ]}
                aria-current={isActive(item.href) ? 'page' : undefined}
              >
                {item.label}
              </a>
            ))
          }
        </nav>
      </div>
    </details>

    <div class="flex items-center gap-2">
      <a class="btn-secondary hidden sm:inline-flex" href={telHref}>Call/Text</a>
      <a class="btn-primary" href={href('contact/')}>Get a Quote</a>
    </div>
  </div>
</header>

<script>
  (() => {
    const menu = document.querySelector('details[data-mobile-menu]') as HTMLDetailsElement | null;
    if (!menu) return;

    const close = () => {
      menu.open = false;
    };

    const overlayBtn = menu.querySelector('[data-menu-close]') as HTMLButtonElement | null;
    overlayBtn?.addEventListener('click', close);

    const links = Array.from(menu.querySelectorAll<HTMLAnchorElement>('a[href]'));
    links.forEach((a) => a.addEventListener('click', close));

    document.addEventListener('keydown', (e) => {
      if (!menu.open) return;
      if (e.key === 'Escape') close();
    });
  })();
</script>
